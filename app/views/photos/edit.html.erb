<h1>Editing <%= @photo.grad_year.year %></h1>

<div id="photo_tagging">
	<%= image_tag @photo.image.url, id: "photoTag" %>
	
</div>

<script>
	window.jcrop_api = {};
	$(function($) {
		$('#photoTag').Jcrop({ onSelect: noteCoords },function() {
			window.jcrop_api = this;
			console.log(this);
		});
		<%- @graduates.each do |g| -%>
			var overlay = $('<div>');
			overlay.attr("id", "overlay-<%= g.id %>");
			var x = <%= g.x %>;
			var y = <%= g.y %>;
			var width = <%= g.x2 %> - x;
			var height = <%= g.y2 %> - y;
			overlay.attr('style', `position: absolute; left: ${x}px; top: ${y}px; z-index: 500; background-color: rgba(1,1,1,0.3); width: ${width}px; height: ${height}px`);
			overlay.html("<%= j render(partial: 'completed_overlay', locals: { graduate: g }) %>");
			$('.jcrop-holder').append(overlay);
		<%- end -%>
		var bubble = $('<div>');
		bubble.attr('id', 'bubble');
		bubble.html('<%= j render 'add_grad_form' %>');
		bubble.attr('style', 'position: absolute; left: 0px; top: 0px; z-index: 500;');
		$('.jcrop-holder').append(bubble);

		// Register form submit action
		$('#new_graduate').submit(function(event) {
			var form = event.target;
			console.log(form)
			$('#coords_x').attr('value', crop_coords.x);
			$('#coords_x2').attr('value', crop_coords.x2);
			$('#coords_y').attr('value', crop_coords.y);
			$('#coords_y2').attr('value', crop_coords.y2);
			var form_fields = $('#new_graduate').serialize();
			console.log(form_fields);
			$.ajax({
				url: form.action,
				method: form.method,
				data:  form_fields,
				success: add_overlay
			});
			return false;

		});
		
	});

	function add_overlay(data) {
		console.log(data);
		var overlay = $('<div>');
		overlay.attr("id", `overlay-${data.id}`);
		var x = data.x;
		var y = data.y;
		var width = data.x2 - x;
		var height = data.y2 - y;
		overlay.attr('style', `position: absolute; left: ${x}px; top: ${y}px; z-index: 500; background-color: rgba(1,1,1,0.3); width: ${width}px; height: ${height}px`);
		overlay.text(data.firstname + data.middlename + data.lastname);
		$('.jcrop-holder').append(overlay);

		window.jcrop_api.setSelect(10, 10, 50, 50);
		window.jcrop_api.release();
		$('#new_graduate')[0].reset();

	}

	function register_delete_form(id) {
		$('#remove-grad-form-' + id).submit(function(event) {
			return false;
		});
		$('#delete-submit-' + id).click(function(event) {
			var form = $('#remove-grad-form-' + id);
			var form_fields = form.serialize();
			var action_text = form.attr('action');
			$.ajax({
				url: action_text,
				method: 'delete',
				data:  form_fields,
				success: function(data) {
					$('#overlay-' + id).remove();
				},
				error: function(data) {
					// todo implement
				}
			});
			return false;
		});
	}

	function noteCoords(c) {
		var bubble = $('#bubble');
		bubble.attr('style', 'position: absolute; left: ' + (c.x2 + 10) + 'px; top: ' + c.y + 'px; z-index: 500;');
		crop_coords = {};
		crop_coords.x = c.x;
		crop_coords.x2 = c.x2;
		crop_coords.y = c.y;
		crop_coords.y2 = c.y2;
	}
</script>
